import { coerceBooleanProperty } from '@angular/cdk/coercion';
import { Directive, ElementRef, HostBinding, HostListener, Input, Renderer2 } from '@angular/core';
const TRANSITION_BREAK_OPACITY = 0.5;
const GRADIENT = 'rgba({{color}}, 0.2) 0, rgba({{color}}, 0.3) 40%, rgba({{color}}, 0.4) 50%, rgba({{color}}, 0.5) 60%, rgba({{color}}, 0) 70%';
const DEFAULT_RIPPLE_COLOR = [0, 0, 0];
const BOOTSTRAP_COLORS = [
    'primary',
    'secondary',
    'success',
    'danger',
    'warning',
    'info',
    'light',
    'dark',
];
export class MdbRippleDirective {
    constructor(_elementRef, _renderer) {
        this._elementRef = _elementRef;
        this._renderer = _renderer;
        this._rippleCentered = false;
        this.rippleColor = '';
        this.rippleDuration = '500ms';
        this.rippleRadius = 0;
        this._rippleUnbound = false;
        this.ripple = true;
    }
    get rippleCentered() {
        return this._rippleCentered;
    }
    set rippleCentered(value) {
        this._rippleCentered = coerceBooleanProperty(value);
    }
    get rippleUnbound() {
        return this._rippleUnbound;
    }
    set rippleUnbound(value) {
        this._rippleUnbound = coerceBooleanProperty(value);
    }
    get host() {
        return this._elementRef.nativeElement;
    }
    _createRipple(event) {
        const { layerX, layerY } = event;
        const offsetX = layerX;
        const offsetY = layerY;
        const height = this.host.offsetHeight;
        const width = this.host.offsetWidth;
        const duration = this._durationToMsNumber(this.rippleDuration);
        const diameterOptions = {
            offsetX: this.rippleCentered ? height / 2 : offsetX,
            offsetY: this.rippleCentered ? width / 2 : offsetY,
            height,
            width,
        };
        const diameter = this._getDiameter(diameterOptions);
        const radiusValue = this.rippleRadius || diameter / 2;
        const opacity = {
            delay: duration * TRANSITION_BREAK_OPACITY,
            duration: duration - duration * TRANSITION_BREAK_OPACITY,
        };
        const styles = {
            left: this.rippleCentered ? `${width / 2 - radiusValue}px` : `${offsetX - radiusValue}px`,
            top: this.rippleCentered ? `${height / 2 - radiusValue}px` : `${offsetY - radiusValue}px`,
            height: `${this.rippleRadius * 2 || diameter}px`,
            width: `${this.rippleRadius * 2 || diameter}px`,
            transitionDelay: `0s, ${opacity.delay}ms`,
            transitionDuration: `${duration}ms, ${opacity.duration}ms`,
        };
        const rippleHTML = this._renderer.createElement('div');
        this._createHTMLRipple(this.host, rippleHTML, styles);
        this._removeHTMLRipple(rippleHTML, duration);
    }
    _createHTMLRipple(wrapper, ripple, styles) {
        Object.keys(styles).forEach((property) => (ripple.style[property] = styles[property]));
        this._renderer.addClass(ripple, 'ripple-wave');
        if (this.rippleColor !== '') {
            this._removeOldColorClasses(wrapper);
            this._addColor(ripple, wrapper);
        }
        this._toggleUnbound(wrapper);
        this._appendRipple(ripple, wrapper);
    }
    _removeHTMLRipple(ripple, duration) {
        setTimeout(() => {
            if (ripple) {
                ripple.remove();
            }
        }, duration);
    }
    _durationToMsNumber(time) {
        return Number(time.replace('ms', '').replace('s', '000'));
    }
    _getDiameter({ offsetX, offsetY, height, width }) {
        const top = offsetY <= height / 2;
        const left = offsetX <= width / 2;
        const pythagorean = (sideA, sideB) => Math.sqrt(Math.pow(sideA, 2) + Math.pow(sideB, 2));
        const positionCenter = offsetY === height / 2 && offsetX === width / 2;
        // mouse position on the quadrants of the coordinate system
        const quadrant = {
            first: top === true && left === false,
            second: top === true && left === true,
            third: top === false && left === true,
            fourth: top === false && left === false,
        };
        const getCorner = {
            topLeft: pythagorean(offsetX, offsetY),
            topRight: pythagorean(width - offsetX, offsetY),
            bottomLeft: pythagorean(offsetX, height - offsetY),
            bottomRight: pythagorean(width - offsetX, height - offsetY),
        };
        let diameter = 0;
        if (positionCenter || quadrant.fourth) {
            diameter = getCorner.topLeft;
        }
        else if (quadrant.third) {
            diameter = getCorner.topRight;
        }
        else if (quadrant.second) {
            diameter = getCorner.bottomRight;
        }
        else if (quadrant.first) {
            diameter = getCorner.bottomLeft;
        }
        return diameter * 2;
    }
    _appendRipple(target, parent) {
        const FIX_ADD_RIPPLE_EFFECT = 50; // delay for active animations
        this._renderer.appendChild(parent, target);
        setTimeout(() => {
            this._renderer.addClass(target, 'active');
        }, FIX_ADD_RIPPLE_EFFECT);
    }
    _toggleUnbound(target) {
        if (this.rippleUnbound) {
            this._renderer.addClass(target, 'ripple-surface-unbound');
        }
        else {
            this._renderer.removeClass(target, 'ripple-surface-unbound');
        }
    }
    _addColor(target, parent) {
        const isBootstrapColor = BOOTSTRAP_COLORS.find((color) => color === this.rippleColor.toLowerCase());
        if (isBootstrapColor) {
            this._renderer.addClass(parent, `${'ripple-surface'}-${this.rippleColor.toLowerCase()}`);
        }
        else {
            const rgbValue = this._colorToRGB(this.rippleColor).join(',');
            const gradientImage = GRADIENT.split('{{color}}').join(`${rgbValue}`);
            target.style.backgroundImage = `radial-gradient(circle, ${gradientImage})`;
        }
    }
    _removeOldColorClasses(target) {
        const REGEXP_CLASS_COLOR = new RegExp(`${'ripple-surface'}-[a-z]+`, 'gi');
        const PARENT_CLASSS_COLOR = target.classList.value.match(REGEXP_CLASS_COLOR) || [];
        PARENT_CLASSS_COLOR.forEach((className) => {
            this._renderer.removeClass(target, className);
        });
    }
    _colorToRGB(color) {
        // eslint-disable-next-line no-shadow,@typescript-eslint/no-shadow
        function hexToRgb(color) {
            const HEX_COLOR_LENGTH = 7;
            const IS_SHORT_HEX = color.length < HEX_COLOR_LENGTH;
            if (IS_SHORT_HEX) {
                color = `#${color[1]}${color[1]}${color[2]}${color[2]}${color[3]}${color[3]}`;
            }
            return [
                parseInt(color.substr(1, 2), 16),
                parseInt(color.substr(3, 2), 16),
                parseInt(color.substr(5, 2), 16),
            ];
        }
        // eslint-disable-next-line no-shadow,@typescript-eslint/no-shadow
        function namedColorsToRgba(color) {
            const tempElem = document.body.appendChild(document.createElement('fictum'));
            const flag = 'rgb(1, 2, 3)';
            tempElem.style.color = flag;
            if (tempElem.style.color !== flag) {
                return DEFAULT_RIPPLE_COLOR;
            }
            tempElem.style.color = color;
            if (tempElem.style.color === flag || tempElem.style.color === '') {
                return DEFAULT_RIPPLE_COLOR;
            } // color parse failed
            color = getComputedStyle(tempElem).color;
            document.body.removeChild(tempElem);
            return color;
        }
        // eslint-disable-next-line no-shadow, @typescript-eslint/no-shadow
        function rgbaToRgb(color) {
            color = color.match(/[.\d]+/g).map((a) => +Number(a));
            color.length = 3;
            return color;
        }
        if (color.toLowerCase() === 'transparent') {
            return DEFAULT_RIPPLE_COLOR;
        }
        if (color[0] === '#') {
            return hexToRgb(color);
        }
        if (color.indexOf('rgb') === -1) {
            color = namedColorsToRgba(color);
        }
        if (color.indexOf('rgb') === 0) {
            return rgbaToRgb(color);
        }
        return DEFAULT_RIPPLE_COLOR;
    }
}
MdbRippleDirective.decorators = [
    { type: Directive, args: [{
                // eslint-disable-next-line @angular-eslint/directive-selector
                selector: '[mdbRipple]',
                exportAs: 'mdbRipple',
            },] }
];
MdbRippleDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 }
];
MdbRippleDirective.propDecorators = {
    rippleCentered: [{ type: Input }],
    rippleColor: [{ type: Input }],
    rippleDuration: [{ type: Input }],
    rippleRadius: [{ type: Input }],
    rippleUnbound: [{ type: Input }],
    ripple: [{ type: HostBinding, args: ['class.ripple-surface',] }],
    _createRipple: [{ type: HostListener, args: ['click', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmlwcGxlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL21kYi1hbmd1bGFyLXVpLWtpdC9yaXBwbGUvcmlwcGxlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWdCLHFCQUFxQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDNUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRW5HLE1BQU0sd0JBQXdCLEdBQUcsR0FBRyxDQUFDO0FBRXJDLE1BQU0sUUFBUSxHQUNaLDhIQUE4SCxDQUFDO0FBQ2pJLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLE1BQU0sZ0JBQWdCLEdBQUc7SUFDdkIsU0FBUztJQUNULFdBQVc7SUFDWCxTQUFTO0lBQ1QsUUFBUTtJQUNSLFNBQVM7SUFDVCxNQUFNO0lBQ04sT0FBTztJQUNQLE1BQU07Q0FDUCxDQUFDO0FBT0YsTUFBTSxPQUFPLGtCQUFrQjtJQXVCN0IsWUFBb0IsV0FBdUIsRUFBVSxTQUFvQjtRQUFyRCxnQkFBVyxHQUFYLFdBQVcsQ0FBWTtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFmakUsb0JBQWUsR0FBRyxLQUFLLENBQUM7UUFFdkIsZ0JBQVcsR0FBRyxFQUFFLENBQUM7UUFDakIsbUJBQWMsR0FBRyxPQUFPLENBQUM7UUFDekIsaUJBQVksR0FBRyxDQUFDLENBQUM7UUFTbEIsbUJBQWMsR0FBRyxLQUFLLENBQUM7UUFRTSxXQUFNLEdBQUcsSUFBSSxDQUFDO0lBTnlCLENBQUM7SUF0QjdFLElBQ0ksY0FBYztRQUNoQixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUM7SUFDOUIsQ0FBQztJQUNELElBQUksY0FBYyxDQUFDLEtBQWM7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dCwgY29lcmNlQm9vbGVhblByb3BlcnR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcbmltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgSG9zdEJpbmRpbmcsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIFJlbmRlcmVyMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5jb25zdCBUUkFOU0lUSU9OX0JSRUFLX09QQUNJVFkgPSAwLjU7XG5cbmNvbnN0IEdSQURJRU5UID1cbiAgJ3JnYmEoe3tjb2xvcn19LCAwLjIpIDAsIHJnYmEoe3tjb2xvcn19LCAwLjMpIDQwJSwgcmdiYSh7e2NvbG9yfX0sIDAuNCkgNTAlLCByZ2JhKHt7Y29sb3J9fSwgMC41KSA2MCUsIHJnYmEoe3tjb2xvcn19LCAwKSA3MCUnO1xuY29uc3QgREVGQVVMVF9SSVBQTEVfQ09MT1IgPSBbMCwgMCwgMF07XG5jb25zdCBCT09UU1RSQVBfQ09MT1JTID0gW1xuICAncHJpbWFyeScsXG4gICdzZWNvbmRhcnknLFxuICAnc3VjY2VzcycsXG4gICdkYW5nZXInLFxuICAnd2FybmluZycsXG4gICdpbmZvJyxcbiAgJ2xpZ2h0JyxcbiAgJ2RhcmsnLFxuXTtcblxuQERpcmVjdGl2ZSh7XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvZGlyZWN0aXZlLXNlbGVjdG9yXG4gIHNlbGVjdG9yOiAnW21kYlJpcHBsZV0nLFxuICBleHBvcnRBczogJ21kYlJpcHBsZScsXG59KVxuZXhwb3J0IGNsYXNzIE1kYlJpcHBsZURpcmVjdGl2ZSB7XG4gIEBJbnB1dCgpXG4gIGdldCByaXBwbGVDZW50ZXJlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5fcmlwcGxlQ2VudGVyZWQ7XG4gIH1cbiAgc2V0IHJpcHBsZUNlbnRlcmVkKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5fcmlwcGxlQ2VudGVyZWQgPSBjb2VyY2VCb29sZWFuUHJvcGVydHkodmFsdWUpO1xuICB9XG4gIHByaXZhdGUgX3JpcHBsZUNlbnRlcmVkID0gZmFsc2U7XG5cbiAgQElucHV0KCkgcmlwcGxlQ29sb3IgPSAnJztcbiAgQElucHV0KCkgcmlwcGxlRHVyYXRpb24gPSAnNTAwbXMnO1xuICBASW5wdXQoKSByaXBwbGVSYWRpdXMgPSAwO1xuXG4gIEBJbnB1dCgpXG4gIGdldCByaXBwbGVVbmJvdW5kKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9yaXBwbGVVbmJvdW5kO1xuICB9XG4gIHNldCByaXBwbGVVbmJvdW5kKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5fcmlwcGxlVW5ib3VuZCA9IGNvZXJjZUJvb2xlYW5Qcm9wZXJ0eSh2YWx1ZSk7XG4gIH1cbiAgcHJpdmF0ZSBfcmlwcGxlVW5ib3VuZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX2VsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHByaXZhdGUgX3JlbmRlcmVyOiBSZW5kZXJlcjIpIHt9XG5cbiAgZ2V0IGhvc3QoKTogSFRNTEVsZW1lbnQge1xuICAgIHJldHVybiB0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzLnJpcHBsZS1zdXJmYWNlJykgcmlwcGxlID0gdHJ1ZTtcblxuICBASG9zdExpc3RlbmVyKCdjbGljaycsIFsnJGV2ZW50J10pXG4gIF9jcmVhdGVSaXBwbGUoZXZlbnQ6IGFueSk6IHZvaWQge1xuICAgIGNvbnN0IHsgbGF5ZXJYLCBsYXllclkgfSA9IGV2ZW50O1xuICAgIGNvbnN0IG9mZnNldFggPSBsYXllclg7XG4gICAgY29uc3Qgb2Zmc2V0WSA9IGxheWVyWTtcbiAgICBjb25zdCBoZWlnaHQgPSB0aGlzLmhvc3Qub2Zmc2V0SGVpZ2h0O1xuICAgIGNvbnN0IHdpZHRoID0gdGhpcy5ob3N0Lm9mZnNldFdpZHRoO1xuICAgIGNvbnN0IGR1cmF0aW9uID0gdGhpcy5fZHVyYXRpb25Ub01zTnVtYmVyKHRoaXMucmlwcGxlRHVyYXRpb24pO1xuICAgIGNvbnN0IGRpYW1ldGVyT3B0aW9ucyA9IHtcbiAgICAgIG9mZnNldFg6IHRoaXMucmlwcGxlQ2VudGVyZWQgPyBoZWlnaHQgLyAyIDogb2Zmc2V0WCxcbiAgICAgIG9mZnNldFk6IHRoaXMucmlwcGxlQ2VudGVyZWQgPyB3aWR0aCAvIDIgOiBvZmZzZXRZLFxuICAgICAgaGVpZ2h0LFxuICAgICAgd2lkdGgsXG4gICAgfTtcbiAgICBjb25zdCBkaWFtZXRlciA9IHRoaXMuX2dldERpYW1ldGVyKGRpYW1ldGVyT3B0aW9ucyk7XG4gICAgY29uc3QgcmFkaXVzVmFsdWUgPSB0aGlzLnJpcHBsZVJhZGl1cyB8fCBkaWFtZXRlciAvIDI7XG5cbiAgICBjb25zdCBvcGFjaXR5ID0ge1xuICAgICAgZGVsYXk6IGR1cmF0aW9uICogVFJBTlNJVElPTl9CUkVBS19PUEFDSVRZLFxuICAgICAgZHVyYXRpb246IGR1cmF0aW9uIC0gZHVyYXRpb24gKiBUUkFOU0lUSU9OX0JSRUFLX09QQUNJVFksXG4gICAgfTtcblxuICAgIGNvbnN0IHN0eWxlcyA9IHtcbiAgICAgIGxlZnQ6IHRoaXMucmlwcGxlQ2VudGVyZWQgPyBgJHt3aWR0aCAvIDIgLSByYWRpdXNWYWx1ZX1weGAgOiBgJHtvZmZzZXRYIC0gcmFkaXVzVmFsdWV9cHhgLFxuICAgICAgdG9wOiB0aGlzLnJpcHBsZUNlbnRlcmVkID8gYCR7aGVpZ2h0IC8gMiAtIHJhZGl1c1ZhbHVlfXB4YCA6IGAke29mZnNldFkgLSByYWRpdXNWYWx1ZX1weGAsXG4gICAgICBoZWlnaHQ6IGAke3RoaXMucmlwcGxlUmFkaXVzICogMiB8fCBkaWFtZXRlcn1weGAsXG4gICAgICB3aWR0aDogYCR7dGhpcy5yaXBwbGVSYWRpdXMgKiAyIHx8IGRpYW1ldGVyfXB4YCxcbiAgICAgIHRyYW5zaXRpb25EZWxheTogYDBzLCAke29wYWNpdHkuZGVsYXl9bXNgLFxuICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uOiBgJHtkdXJhdGlvbn1tcywgJHtvcGFjaXR5LmR1cmF0aW9ufW1zYCxcbiAgICB9O1xuXG4gICAgY29uc3QgcmlwcGxlSFRNTCA9IHRoaXMuX3JlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuXG4gICAgdGhpcy5fY3JlYXRlSFRNTFJpcHBsZSh0aGlzLmhvc3QsIHJpcHBsZUhUTUwsIHN0eWxlcyk7XG4gICAgdGhpcy5fcmVtb3ZlSFRNTFJpcHBsZShyaXBwbGVIVE1MLCBkdXJhdGlvbik7XG4gIH1cblxuICBwcml2YXRlIF9jcmVhdGVIVE1MUmlwcGxlKHdyYXBwZXI6IEhUTUxFbGVtZW50LCByaXBwbGU6IEhUTUxFbGVtZW50LCBzdHlsZXM6IGFueSk6IHZvaWQge1xuICAgIE9iamVjdC5rZXlzKHN0eWxlcykuZm9yRWFjaCgocHJvcGVydHkpID0+IChyaXBwbGUuc3R5bGVbcHJvcGVydHldID0gc3R5bGVzW3Byb3BlcnR5XSkpO1xuICAgIHRoaXMuX3JlbmRlcmVyLmFkZENsYXNzKHJpcHBsZSwgJ3JpcHBsZS13YXZlJyk7XG5cbiAgICBpZiAodGhpcy5yaXBwbGVDb2xvciAhPT0gJycpIHtcbiAgICAgIHRoaXMuX3JlbW92ZU9sZENvbG9yQ2xhc3Nlcyh3cmFwcGVyKTtcbiAgICAgIHRoaXMuX2FkZENvbG9yKHJpcHBsZSwgd3JhcHBlcik7XG4gICAgfVxuXG4gICAgdGhpcy5fdG9nZ2xlVW5ib3VuZCh3cmFwcGVyKTtcbiAgICB0aGlzLl9hcHBlbmRSaXBwbGUocmlwcGxlLCB3cmFwcGVyKTtcbiAgfVxuXG4gIHByaXZhdGUgX3JlbW92ZUhUTUxSaXBwbGUocmlwcGxlOiBIVE1MRWxlbWVudCwgZHVyYXRpb246IG51bWJlcik6IHZvaWQge1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgaWYgKHJpcHBsZSkge1xuICAgICAgICByaXBwbGUucmVtb3ZlKCk7XG4gICAgICB9XG4gICAgfSwgZHVyYXRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBfZHVyYXRpb25Ub01zTnVtYmVyKHRpbWU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgcmV0dXJuIE51bWJlcih0aW1lLnJlcGxhY2UoJ21zJywgJycpLnJlcGxhY2UoJ3MnLCAnMDAwJykpO1xuICB9XG5cbiAgX2dldERpYW1ldGVyKHsgb2Zmc2V0WCwgb2Zmc2V0WSwgaGVpZ2h0LCB3aWR0aCB9KTogbnVtYmVyIHtcbiAgICBjb25zdCB0b3AgPSBvZmZzZXRZIDw9IGhlaWdodCAvIDI7XG4gICAgY29uc3QgbGVmdCA9IG9mZnNldFggPD0gd2lkdGggLyAyO1xuICAgIGNvbnN0IHB5dGhhZ29yZWFuID0gKHNpZGVBLCBzaWRlQikgPT4gTWF0aC5zcXJ0KHNpZGVBICoqIDIgKyBzaWRlQiAqKiAyKTtcblxuICAgIGNvbnN0IHBvc2l0aW9uQ2VudGVyID0gb2Zmc2V0WSA9PT0gaGVpZ2h0IC8gMiAmJiBvZmZzZXRYID09PSB3aWR0aCAvIDI7XG4gICAgLy8gbW91c2UgcG9zaXRpb24gb24gdGhlIHF1YWRyYW50cyBvZiB0aGUgY29vcmRpbmF0ZSBzeXN0ZW1cbiAgICBjb25zdCBxdWFkcmFudCA9IHtcbiAgICAgIGZpcnN0OiB0b3AgPT09IHRydWUgJiYgbGVmdCA9PT0gZmFsc2UsXG4gICAgICBzZWNvbmQ6IHRvcCA9PT0gdHJ1ZSAmJiBsZWZ0ID09PSB0cnVlLFxuICAgICAgdGhpcmQ6IHRvcCA9PT0gZmFsc2UgJiYgbGVmdCA9PT0gdHJ1ZSxcbiAgICAgIGZvdXJ0aDogdG9wID09PSBmYWxzZSAmJiBsZWZ0ID09PSBmYWxzZSxcbiAgICB9O1xuXG4gICAgY29uc3QgZ2V0Q29ybmVyID0ge1xuICAgICAgdG9wTGVmdDogcHl0aGFnb3JlYW4ob2Zmc2V0WCwgb2Zmc2V0WSksXG4gICAgICB0b3BSaWdodDogcHl0aGFnb3JlYW4od2lkdGggLSBvZmZzZXRYLCBvZmZzZXRZKSxcbiAgICAgIGJvdHRvbUxlZnQ6IHB5dGhhZ29yZWFuKG9mZnNldFgsIGhlaWdodCAtIG9mZnNldFkpLFxuICAgICAgYm90dG9tUmlnaHQ6IHB5dGhhZ29yZWFuKHdpZHRoIC0gb2Zmc2V0WCwgaGVpZ2h0IC0gb2Zmc2V0WSksXG4gICAgfTtcblxuICAgIGxldCBkaWFtZXRlciA9IDA7XG5cbiAgICBpZiAocG9zaXRpb25DZW50ZXIgfHwgcXVhZHJhbnQuZm91cnRoKSB7XG4gICAgICBkaWFtZXRlciA9IGdldENvcm5lci50b3BMZWZ0O1xuICAgIH0gZWxzZSBpZiAocXVhZHJhbnQudGhpcmQpIHtcbiAgICAgIGRpYW1ldGVyID0gZ2V0Q29ybmVyLnRvcFJpZ2h0O1xuICAgIH0gZWxzZSBpZiAocXVhZHJhbnQuc2Vjb25kKSB7XG4gICAgICBkaWFtZXRlciA9IGdldENvcm5lci5ib3R0b21SaWdodDtcbiAgICB9IGVsc2UgaWYgKHF1YWRyYW50LmZpcnN0KSB7XG4gICAgICBkaWFtZXRlciA9IGdldENvcm5lci5ib3R0b21MZWZ0O1xuICAgIH1cbiAgICByZXR1cm4gZGlhbWV0ZXIgKiAyO1xuICB9XG5cbiAgX2FwcGVuZFJpcHBsZSh0YXJnZXQ6IEhUTUxFbGVtZW50LCBwYXJlbnQ6IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgY29uc3QgRklYX0FERF9SSVBQTEVfRUZGRUNUID0gNTA7IC8vIGRlbGF5IGZvciBhY3RpdmUgYW5pbWF0aW9uc1xuICAgIHRoaXMuX3JlbmRlcmVyLmFwcGVuZENoaWxkKHBhcmVudCwgdGFyZ2V0KTtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuX3JlbmRlcmVyLmFkZENsYXNzKHRhcmdldCwgJ2FjdGl2ZScpO1xuICAgIH0sIEZJWF9BRERfUklQUExFX0VGRkVDVCk7XG4gIH1cblxuICBfdG9nZ2xlVW5ib3VuZCh0YXJnZXQ6IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgaWYgKHRoaXMucmlwcGxlVW5ib3VuZCkge1xuICAgICAgdGhpcy5fcmVuZGVyZXIuYWRkQ2xhc3ModGFyZ2V0LCAncmlwcGxlLXN1cmZhY2UtdW5ib3VuZCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9yZW5kZXJlci5yZW1vdmVDbGFzcyh0YXJnZXQsICdyaXBwbGUtc3VyZmFjZS11bmJvdW5kJyk7XG4gICAgfVxuICB9XG5cbiAgX2FkZENvbG9yKHRhcmdldDogSFRNTEVsZW1lbnQsIHBhcmVudDogSFRNTEVsZW1lbnQpOiB2b2lkIHtcbiAgICBjb25zdCBpc0Jvb3RzdHJhcENvbG9yID0gQk9PVFNUUkFQX0NPTE9SUy5maW5kKFxuICAgICAgKGNvbG9yKSA9PiBjb2xvciA9PT0gdGhpcy5yaXBwbGVDb2xvci50b0xvd2VyQ2FzZSgpXG4gICAgKTtcblxuICAgIGlmIChpc0Jvb3RzdHJhcENvbG9yKSB7XG4gICAgICB0aGlzLl9yZW5kZXJlci5hZGRDbGFzcyhwYXJlbnQsIGAkeydyaXBwbGUtc3VyZmFjZSd9LSR7dGhpcy5yaXBwbGVDb2xvci50b0xvd2VyQ2FzZSgpfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCByZ2JWYWx1ZSA9IHRoaXMuX2NvbG9yVG9SR0IodGhpcy5yaXBwbGVDb2xvcikuam9pbignLCcpO1xuICAgICAgY29uc3QgZ3JhZGllbnRJbWFnZSA9IEdSQURJRU5ULnNwbGl0KCd7e2NvbG9yfX0nKS5qb2luKGAke3JnYlZhbHVlfWApO1xuICAgICAgdGFyZ2V0LnN0eWxlLmJhY2tncm91bmRJbWFnZSA9IGByYWRpYWwtZ3JhZGllbnQoY2lyY2xlLCAke2dyYWRpZW50SW1hZ2V9KWA7XG4gICAgfVxuICB9XG5cbiAgX3JlbW92ZU9sZENvbG9yQ2xhc3Nlcyh0YXJnZXQ6IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgY29uc3QgUkVHRVhQX0NMQVNTX0NPTE9SID0gbmV3IFJlZ0V4cChgJHsncmlwcGxlLXN1cmZhY2UnfS1bYS16XStgLCAnZ2knKTtcbiAgICBjb25zdCBQQVJFTlRfQ0xBU1NTX0NPTE9SID0gdGFyZ2V0LmNsYXNzTGlzdC52YWx1ZS5tYXRjaChSRUdFWFBfQ0xBU1NfQ09MT1IpIHx8IFtdO1xuICAgIFBBUkVOVF9DTEFTU1NfQ09MT1IuZm9yRWFjaCgoY2xhc3NOYW1lKSA9PiB7XG4gICAgICB0aGlzLl9yZW5kZXJlci5yZW1vdmVDbGFzcyh0YXJnZXQsIGNsYXNzTmFtZSk7XG4gICAgfSk7XG4gIH1cblxuICBfY29sb3JUb1JHQihjb2xvcjogYW55KTogbnVtYmVyW10ge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1zaGFkb3csQHR5cGVzY3JpcHQtZXNsaW50L25vLXNoYWRvd1xuICAgIGZ1bmN0aW9uIGhleFRvUmdiKGNvbG9yOiBhbnkpOiBhbnkge1xuICAgICAgY29uc3QgSEVYX0NPTE9SX0xFTkdUSCA9IDc7XG4gICAgICBjb25zdCBJU19TSE9SVF9IRVggPSBjb2xvci5sZW5ndGggPCBIRVhfQ09MT1JfTEVOR1RIO1xuICAgICAgaWYgKElTX1NIT1JUX0hFWCkge1xuICAgICAgICBjb2xvciA9IGAjJHtjb2xvclsxXX0ke2NvbG9yWzFdfSR7Y29sb3JbMl19JHtjb2xvclsyXX0ke2NvbG9yWzNdfSR7Y29sb3JbM119YDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBbXG4gICAgICAgIHBhcnNlSW50KGNvbG9yLnN1YnN0cigxLCAyKSwgMTYpLFxuICAgICAgICBwYXJzZUludChjb2xvci5zdWJzdHIoMywgMiksIDE2KSxcbiAgICAgICAgcGFyc2VJbnQoY29sb3Iuc3Vic3RyKDUsIDIpLCAxNiksXG4gICAgICBdO1xuICAgIH1cblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1zaGFkb3csQHR5cGVzY3JpcHQtZXNsaW50L25vLXNoYWRvd1xuICAgIGZ1bmN0aW9uIG5hbWVkQ29sb3JzVG9SZ2JhKGNvbG9yOiBhbnkpOiBhbnkge1xuICAgICAgY29uc3QgdGVtcEVsZW0gPSBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ZpY3R1bScpKTtcbiAgICAgIGNvbnN0IGZsYWcgPSAncmdiKDEsIDIsIDMpJztcbiAgICAgIHRlbXBFbGVtLnN0eWxlLmNvbG9yID0gZmxhZztcbiAgICAgIGlmICh0ZW1wRWxlbS5zdHlsZS5jb2xvciAhPT0gZmxhZykge1xuICAgICAgICByZXR1cm4gREVGQVVMVF9SSVBQTEVfQ09MT1I7XG4gICAgICB9XG4gICAgICB0ZW1wRWxlbS5zdHlsZS5jb2xvciA9IGNvbG9yO1xuICAgICAgaWYgKHRlbXBFbGVtLnN0eWxlLmNvbG9yID09PSBmbGFnIHx8IHRlbXBFbGVtLnN0eWxlLmNvbG9yID09PSAnJykge1xuICAgICAgICByZXR1cm4gREVGQVVMVF9SSVBQTEVfQ09MT1I7XG4gICAgICB9IC8vIGNvbG9yIHBhcnNlIGZhaWxlZFxuICAgICAgY29sb3IgPSBnZXRDb21wdXRlZFN0eWxlKHRlbXBFbGVtKS5jb2xvcjtcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGVtcEVsZW0pO1xuICAgICAgcmV0dXJuIGNvbG9yO1xuICAgIH1cblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1zaGFkb3csIEB0eXBlc2NyaXB0LWVzbGludC9uby1zaGFkb3dcbiAgICBmdW5jdGlvbiByZ2JhVG9SZ2IoY29sb3I6IGFueSk6IGFueSB7XG4gICAgICBjb2xvciA9IGNvbG9yLm1hdGNoKC9bLlxcZF0rL2cpLm1hcCgoYSkgPT4gK051bWJlcihhKSk7XG4gICAgICBjb2xvci5sZW5ndGggPSAzO1xuICAgICAgcmV0dXJuIGNvbG9yO1xuICAgIH1cblxuICAgIGlmIChjb2xvci50b0xvd2VyQ2FzZSgpID09PSAndHJhbnNwYXJlbnQnKSB7XG4gICAgICByZXR1cm4gREVGQVVMVF9SSVBQTEVfQ09MT1I7XG4gICAgfVxuICAgIGlmIChjb2xvclswXSA9PT0gJyMnKSB7XG4gICAgICByZXR1cm4gaGV4VG9SZ2IoY29sb3IpO1xuICAgIH1cbiAgICBpZiAoY29sb3IuaW5kZXhPZigncmdiJykgPT09IC0xKSB7XG4gICAgICBjb2xvciA9IG5hbWVkQ29sb3JzVG9SZ2JhKGNvbG9yKTtcbiAgICB9XG4gICAgaWYgKGNvbG9yLmluZGV4T2YoJ3JnYicpID09PSAwKSB7XG4gICAgICByZXR1cm4gcmdiYVRvUmdiKGNvbG9yKTtcbiAgICB9XG5cbiAgICByZXR1cm4gREVGQVVMVF9SSVBQTEVfQ09MT1I7XG4gIH1cblxuICBzdGF0aWMgbmdBY2NlcHRJbnB1dFR5cGVfcmlwcGxlQ2VudGVyZWQ6IEJvb2xlYW5JbnB1dDtcbiAgc3RhdGljIG5nQWNjZXB0SW5wdXRUeXBlX3JpcHBsZVVuYm91bmQ6IEJvb2xlYW5JbnB1dDtcbn1cbiJdfQ==